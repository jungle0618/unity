# 目標（Target）AI 系統

## 狀態機（State Machine）

目標使用有限狀態機控制行為，共有 2 種狀態：

### 1. Stay（停留）
- **行為**：停留在原地，不移動
- **視野**：持續偵測玩家
- **轉換條件**：
  - 看到玩家 → `Escape`（開始逃亡）
  - 聽到槍聲 → `Escape`（開始逃亡）

### 2. Escape（逃亡）
- **行為**：向逃亡點移動
- **移動策略**：根據危險等級決定逃亡路線
  - **非 Safe 等級**：直接走最短路徑到逃亡點
  - **Safe 等級**：先前往最近的守衛位置，到達後再走最短路徑到逃亡點
- **視野**：朝向移動方向
- **轉換條件**：
  - 到達逃亡點 → 停止移動（完成逃亡）

### 3. Dead（死亡）
- **行為**：停止所有移動和 AI 邏輯
- **最終狀態**：不可逆

## 偵測系統

### 視野偵測
- **視野範圍**：`viewRange`（預設 8 單位）
- **視野角度**：`viewAngle`（預設 90 度）

### 遮擋判斷
- 玩家**站立**時：只有牆壁（Walls）會遮擋視線
- 玩家**蹲下**時：牆壁 + 物件（Objects）都會遮擋視線

### 距離計算
使用平方距離優化性能（避免開方運算）

## 移動系統

### 移動模式
1. **直線移動**：無障礙物時直接朝目標移動
2. **路徑規劃**：有障礙物時使用 Greedy Pathfinding 繞過

### 速度設定
- 基礎速度：`speed`（預設 2）
- 逃亡速度：`escapeSpeed`（預設 3）

## 逃亡路線邏輯

### 危險等級判斷
目標會根據 `DangerousManager` 的當前危險等級決定逃亡策略：

#### 非 Safe 等級（Low、Medium、High、Critical）
- **策略**：直接走最短路徑到逃亡點
- **原因**：情況緊急，需要盡快逃離

#### Safe 等級
- **策略**：兩階段逃亡
  1. **第一階段**：前往最近的守衛位置
     - 使用 `EntityManager` 獲取所有活躍的守衛（Enemy）
     - 計算距離最近的守衛位置
     - 如果找不到守衛，則直接前往逃亡點
  2. **第二階段**：到達守衛位置後，走最短路徑到逃亡點

### 逃亡點
- **設定方式**：由外部系統（如 `EntityManager`）透過 `SetEscapePoint()` 設定
- **完成條件**：目標到達逃亡點（距離 < 1 單位）

## 槍聲警報系統

### 觸發條件
玩家開槍時，目標會被通知（透過 `NotifyPlayerPosition()` 方法）

### 目標反應
- `Stay` → `Escape`（開始逃亡）
- `Escape` → 繼續逃亡（不改變狀態）

### 槍聲反應邏輯
當目標聽到槍聲時：
1. 如果當前處於 `Stay` 狀態，立即切換到 `Escape` 狀態
2. 根據當前危險等級決定逃亡路線（見「逃亡路線邏輯」）

## AI 更新頻率

### 性能優化
- **AI 決策**：每 0.15 秒更新一次（`aiUpdateInterval`）
- **移動執行**：每幀更新（`FixedUpdate`）
- **快取更新**：每 0.1 秒更新位置和偵測資訊（`CACHE_UPDATE_INTERVAL`）

這種分離確保移動流暢，同時降低 CPU 負載。

## 攝影機剔除系統（Camera Culling）

### 概述
攝影機剔除是此遊戲的核心性能優化功能。由於遊戲與攝影機範圍密切相關，系統會根據目標是否在攝影機視野內來決定是否執行 AI 邏輯。

### 工作原理

1. **視野檢查**：
   - 系統會將目標的世界座標轉換為螢幕座標
   - 檢查目標是否在攝影機視野範圍內（包含邊距 `cameraCullMargin`）
   - 邊距預設為 2 單位，避免目標在螢幕邊緣時頻繁切換

2. **視野外判斷條件**：
   - X 座標 < -邊距 或 > 螢幕寬度 + 邊距
   - Y 座標 < -邊距 或 > 螢幕高度 + 邊距
   - Z 座標 < 0（在攝影機後方）

### 視野外行為限制

當目標**不在 `Escape` 狀態**，且**不在攝影機範圍內**時：

#### ❌ 不會執行的行為
- **不進行偵測**（`detection`）：不會執行視野偵測、距離計算等偵測邏輯
- **不會改變狀態**（`state`）：狀態機不會更新，不會觸發狀態轉換
- **不會對外在事物做出反應**：
  - 不會對槍聲警報做出反應
  - 不會對玩家位置變化做出反應
  - 不會對其他外部事件做出反應

#### ✅ 仍會執行的行為
- **移動**：目標在 `Escape` 狀態下仍會繼續移動（逃亡邏輯仍會執行）
  - 這確保目標在視野外時仍能正常移動到需要的位置
  - 移動邏輯在 `FixedUpdate` 中執行，不受攝影機剔除影響

### 例外情況：Escape 狀態

當目標處於 `Escape`（逃亡）狀態時，**即使不在攝影機視野內**，仍會：

- ✅ 繼續執行偵測邏輯
- ✅ 繼續更新狀態機
- ✅ 繼續對外在事件做出反應

**原因**：逃亡狀態是重要的行為，即使暫時離開視野，也需要持續追蹤玩家和逃亡進度，確保遊戲邏輯的連續性。

### 性能效益

1. **大幅減少 CPU 負載**：
   - 視野外的目標不會執行昂貴的偵測計算
   - 減少不必要的狀態機更新
   - 特別在大型場景中有顯著性能提升

2. **維持遊戲體驗**：
   - 重要狀態（Escape）仍會正常運作
   - 移動邏輯不受影響，確保目標在視野外時仍能正常移動

3. **與遊戲機制整合**：
   - 符合遊戲與攝影機範圍密切相關的設計理念
   - 玩家只能看到視野內的目標行為，視野外的目標可以暫時「休眠」

### 參數設定

- **`enableCameraCulling`**：啟用/禁用攝影機剔除（預設：`true`）
- **`cameraCullMargin`**：攝影機剔除邊距（預設：`2` 單位）

### 實現邏輯

```
如果 (啟用攝影機剔除 且 目標在攝影機視野外):
    如果 (當前狀態 == Escape):
        繼續執行偵測和狀態更新
    否則:
        跳過偵測和狀態更新
        但繼續執行移動邏輯
否則:
    正常執行所有邏輯
```

## 狀態轉換圖

### 基本狀態轉換
```
     ┌──────────┐
     │   Stay   │
     └────┬─────┘
          │看到玩家
          │聽到槍聲
          ▼
     ┌──────────┐
     │  Escape  │
     └────┬─────┘
          │到達逃亡點
          ▼
       停止移動
```

### 槍聲反應路徑
```
槍聲觸發
    │
    └─ Stay → Escape
```

## 狀態轉換優先級

當多個轉換條件同時滿足時，優先級如下：

1. **最高優先級**：看到玩家（在大部分狀態下會立即轉換）
2. **高優先級**：聽到槍聲（根據當前狀態決定反應）

## 改進建議與擴展

### 可能的擴展狀態

#### Panic（恐慌）
- **行為**：看到玩家後短暫停留或隨機移動，然後才開始逃亡
- **用途**：增加遊戲真實感，模擬目標的恐慌反應
- **轉換條件**：
  - 看到玩家 → `Panic`（持續 0.5-1 秒）→ `Escape`
  - 聽到槍聲 → `Escape`（直接逃亡，不經過恐慌）

#### Hide（躲藏）
- **行為**：在逃亡過程中尋找掩體或隱藏點
- **用途**：更智能的逃亡行為，增加遊戲難度
- **轉換條件**：
  - 在 `Escape` 狀態下找到掩體 → `Hide`
  - 玩家離開或失去視線 → `Escape`（繼續逃亡）

### 性能優化建議

1. **狀態機更新頻率調整**：
   - 可以根據目標距離玩家的遠近動態調整更新頻率
   - 遠處的目標使用更低的更新頻率（如 0.3 秒）
   - 近處的目標使用標準更新頻率（0.15 秒）

2. **視野偵測優化**：
   - 已經實現了攝影機剔除（`cameraCulling`）
   - 可以進一步優化：只在需要時進行視線檢測

3. **路徑規劃優化**：
   - 可以快取常用路徑
   - 使用更高效的尋路算法（如 A*）

### 邏輯改進建議

1. **多目標協同**：
   - 當一個目標發現玩家時，可以通知其他目標
   - 多個目標可以協同逃亡，增加遊戲緊張感

2. **逃亡點動態選擇**：
   - 可以根據當前危險等級動態選擇逃亡點
   - 不同危險等級可以有不同的逃亡點

3. **逃亡行為變化**：
   - 可以根據目標的個性設定不同的逃亡行為
   - 有些目標可能更積極地尋找守衛幫助
   - 有些目標可能更傾向於直接逃離

