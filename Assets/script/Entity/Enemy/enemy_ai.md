# 警衛（Enemy）AI 系統

## 狀態機（State Machine）

警衛使用有限狀態機控制行為，共有 6 種狀態：

### 1. Patrol（巡邏）
- **行為**：沿著預設的巡邏點循環移動
- **視野**：跟隨移動方向
- **轉換條件**：
  - 看到玩家 → `Alert`
  - 聽到槍聲 → `Alert`（進入警戒狀態）

### 2. Alert（警戒）
- **行為**：繼續巡邏路線，但保持警戒
- **持續時間**：預設 2 秒（`alertTime`）
- **計時器重置**：每次進入 Alert 狀態時，計時器會重置為 `alertTime`
- **轉換條件**：
  - 看到玩家 → `Chase`
  - 警戒時間結束 → `Patrol`
  - 聽到槍聲 → `Search`（前往槍聲位置）

### 3. Chase（追擊）
- **行為**：
  - 直接追向玩家（如果無障礙物）
  - 使用路徑規劃繞過障礙物
  - 在攻擊範圍內嘗試攻擊
- **視野**：朝向玩家
- **武器**：自動瞄準玩家
- **轉換條件**：
  - 失去視線且有最後位置 → `Search`
  - 失去視線且無最後位置 → `Alert`
  - 超出追擊範圍 → `Return`
  - 卡住或撞牆 → `Search`
  - 聽到槍聲 → 更新玩家位置（繼續追擊狀態）

### 4. Search（搜索）
- **行為**：前往玩家最後出現的位置
- **視野**：朝向移動路徑的下一個點
- **搜索時間**：從最後看到玩家的時間（`lastSeenTime`）開始計算，預設 3 秒（`searchTime`）
- **轉換條件**：
  - 在前往搜索位置途中看到玩家 → 更新目標位置，繼續前往新位置
  - 到達搜索位置後重新看到玩家 → `Chase`
  - 到達搜索位置且搜索時間結束（從最後看到玩家開始計算，3 秒）→ `Alert`
  - 超出追擊範圍 → `Return`
  - 聽到槍聲 → 更新目標位置並繼續 `Search`

### 5. Return（返回）
- **行為**：返回第一個巡邏點（出生點）
- **轉換條件**：
  - 到達出生點 → `Patrol`
  - 看到玩家 → `Chase`（如果看到玩家，立即追擊）
  - 聽到槍聲 → `Search`（前往槍聲位置）

### 6. Dead（死亡）
- **行為**：停止所有移動和 AI 邏輯
- **最終狀態**：不可逆

## 偵測系統

### 視野偵測
- **視野範圍**：`viewRange`（預設 8 單位）
- **視野角度**：`viewAngle`（預設 90 度）
- **追擊範圍**：`chaseRange`（預設 15 單位）

### 遮擋判斷
- 玩家**站立**時：只有牆壁（Walls）會遮擋視線
- 玩家**蹲下**時：牆壁 + 物件（Objects）都會遮擋視線

### 距離計算
使用平方距離優化性能（避免開方運算）

## 移動系統

### 移動模式
1. **直線追擊**：無障礙物時直接朝玩家移動
2. **路徑規劃**：有障礙物時使用 Greedy Pathfinding 繞過
3. **卡住檢測**：如果卡住或撞牆會自動切換到搜索狀態

### 速度設定
- 基礎速度：`speed`（預設 2）
- 追擊速度：`speed × chaseSpeedMultiplier`（預設 1.5 倍）

## 攻擊系統

### 攻擊條件
1. 處於 `Chase` 狀態
2. 玩家在攻擊偵測範圍內（`attackDetectionRange`，預設 3 單位）
3. 攻擊冷卻完成（`attackCooldown`，預設 1 秒）
4. 擁有可用武器且武器可以攻擊

### 攻擊流程
1. 武器朝向玩家
2. 呼叫 `ItemHolder.TryAttack()`
3. 由武器執行實際攻擊邏輯

**注意**：`attackDetectionRange` 是觸發攻擊嘗試的距離，實際攻擊範圍由武器本身決定（近戰或遠程武器有不同的攻擊範圍）。

## 槍聲警報系統

### 觸發條件
玩家開槍時，`alertRange` 範圍內的所有敵人會被通知

### 敵人反應
- `Patrol` → `Alert`（進入警戒）
- `Alert` / `Return` → `Search`（前往槍聲位置）
- `Chase` / `Search` → 更新玩家位置（繼續當前狀態）

### 槍聲反應邏輯
當敵人聽到槍聲時：
1. 記錄玩家位置作為最後看到的位置
2. 根據當前狀態決定行為：
   - 如果正在巡邏，進入警戒狀態
   - 如果正在警戒或返回，切換到搜索狀態前往槍聲位置
   - 如果正在追擊或搜索，更新目標位置繼續當前行為

## AI 更新頻率

### 性能優化
- **AI 決策**：每 0.15 秒更新一次（`aiUpdateInterval`）
- **移動執行**：每幀更新（`FixedUpdate`）
- **快取更新**：每 0.1 秒更新位置和偵測資訊（`CACHE_UPDATE_INTERVAL`）

這種分離確保移動流暢，同時降低 CPU 負載。

## 攝影機剔除系統（Camera Culling）

### 概述
攝影機剔除是此遊戲的核心性能優化功能。由於遊戲與攝影機範圍密切相關，系統會根據敵人是否在攝影機視野內來決定是否執行 AI 邏輯。

### 工作原理

1. **視野檢查**：
   - 系統會將敵人的世界座標轉換為螢幕座標
   - 檢查敵人是否在攝影機視野範圍內（包含邊距 `cameraCullMargin`）
   - 邊距預設為 2 單位，避免敵人在螢幕邊緣時頻繁切換

2. **視野外判斷條件**：
   - X 座標 < -邊距 或 > 螢幕寬度 + 邊距
   - Y 座標 < -邊距 或 > 螢幕高度 + 邊距
   - Z 座標 < 0（在攝影機後方）

### 視野外行為限制

當敵人**不在 `Chase` 或 `Search` 狀態**，且**不在攝影機範圍內**時：

#### ❌ 不會執行的行為
- **不進行偵測**（`detection`）：不會執行視野偵測、距離計算等偵測邏輯
- **不會改變狀態**（`state`）：狀態機不會更新，不會觸發狀態轉換
- **不會對外在事物做出反應**：
  - 不會對槍聲警報做出反應
  - 不會對玩家位置變化做出反應
  - 不會對其他外部事件做出反應

#### ✅ 仍會執行的行為
- **移動**：敵人仍會繼續移動（巡邏、返回等移動邏輯仍會執行）
  - 這確保敵人在視野外時仍能正常移動到需要的位置
  - 移動邏輯在 `FixedUpdate` 中執行，不受攝影機剔除影響

### 例外情況：Chase 和 Search 狀態

當敵人處於 `Chase`（追擊）或 `Search`（搜索）狀態時，**即使不在攝影機視野內**，仍會：

- ✅ 繼續執行偵測邏輯
- ✅ 繼續更新狀態機
- ✅ 繼續對外在事件做出反應

**原因**：這兩個狀態是重要的追擊行為，即使暫時離開視野，也需要持續追蹤玩家，確保遊戲邏輯的連續性。

### 性能效益

1. **大幅減少 CPU 負載**：
   - 視野外的敵人不會執行昂貴的偵測計算
   - 減少不必要的狀態機更新
   - 特別在大型場景中有顯著性能提升

2. **維持遊戲體驗**：
   - 重要狀態（Chase/Search）仍會正常運作
   - 移動邏輯不受影響，確保敵人在視野外時仍能正常移動

3. **與遊戲機制整合**：
   - 符合遊戲與攝影機範圍密切相關的設計理念
   - 玩家只能看到視野內的敵人行為，視野外的敵人可以暫時「休眠」

### 參數設定

- **`enableCameraCulling`**：啟用/禁用攝影機剔除（預設：`true`）
- **`cameraCullMargin`**：攝影機剔除邊距（預設：`2` 單位）

### 實現邏輯

```
如果 (啟用攝影機剔除 且 敵人在攝影機視野外):
    如果 (當前狀態 == Chase 或 Search):
        繼續執行偵測和狀態更新
    否則:
        跳過偵測和狀態更新
        但繼續執行移動邏輯
否則:
    正常執行所有邏輯
```

## 狀態轉換圖

### 基本狀態轉換
```
     ┌──────────┐
     │  Patrol  │ ◄────┐
     └────┬─────┘      │
          │看到玩家      │
          │聽到槍聲      │警戒結束
          ▼            │
     ┌──────────┐      │
     │  Alert   │──────┘
     └────┬─────┘
          │看到玩家
          │聽到槍聲→Search
          ▼
     ┌──────────┐
     │  Chase   │ ◄────┐
     └────┬─────┘      │
          │失去視線      │重新看到
          │卡住          │
          ▼            │
     ┌──────────┐      │
     │  Search  │──────┘
     └────┬─────┘
          │超出範圍
          │看到玩家→Chase
          ▼
     ┌──────────┐
     │  Return  │
     └────┬─────┘
          │到達出生點
          │看到玩家→Chase
          │聽到槍聲→Search
          ▼
     ┌──────────┐
     │  Patrol  │
     └──────────┘
```

### 槍聲反應路徑
```
槍聲觸發
    │
    ├─ Patrol → Alert
    ├─ Alert → Search
    ├─ Return → Search
    ├─ Chase → 更新位置（繼續 Chase）
    └─ Search → 更新位置（繼續 Search）
```

## 狀態轉換優先級

當多個轉換條件同時滿足時，優先級如下：

1. **最高優先級**：看到玩家（在大部分狀態下會立即轉換）
2. **高優先級**：聽到槍聲（根據當前狀態決定反應）
3. **中優先級**：失去視線、卡住、超出範圍
4. **低優先級**：時間相關（警戒時間結束、搜索時間結束）

## 改進建議與擴展

### 可能的擴展狀態

#### Guard（站崗）
- **行為**：在固定位置停留，360 度旋轉視野
- **用途**：保護重要區域的警衛
- **轉換條件**：
  - 看到玩家 → `Alert` 或 `Chase`
  - 聽到槍聲 → `Alert`

#### Investigate（調查）
- **行為**：前往可疑位置（如玩家最後出現的位置）進行調查
- **用途**：更智能的搜索行為，可以檢查多個可疑點
- **轉換條件**：
  - 看到玩家 → `Chase`
  - 調查完成 → `Alert` 或 `Patrol`
  - 聽到槍聲 → 更新調查目標

### 性能優化建議

1. **狀態機更新頻率調整**：
   - 可以根據敵人距離玩家的遠近動態調整更新頻率
   - 遠處的敵人使用更低的更新頻率（如 0.3 秒）
   - 近處的敵人使用標準更新頻率（0.15 秒）

2. **視野偵測優化**：
   - 已經實現了攝影機剔除（`cameraCulling`）
   - 可以進一步優化：只在需要時進行視線檢測

3. **路徑規劃優化**：
   - 可以快取常用路徑
   - 使用更高效的尋路算法（如 A*）

### 邏輯改進建議

1. **協同作戰**：
   - 當一個警衛發現玩家時，可以通知附近的警衛
   - 多個警衛可以協同追擊

2. **警戒區域**：
   - 警衛可以設定警戒區域，離開區域後會停止追擊
   - 可以在警戒區域內設置優先巡邏路線

3. **攻擊策略**：
   - 可以根據武器類型調整攻擊距離
   - 近戰武器應該更積極地接近玩家
   - 遠程武器可以保持距離

4. **搜索模式改進**：
   - 可以實現多點搜索（檢查多個可疑位置）
   - 可以根據玩家移動方向預測下一步位置
